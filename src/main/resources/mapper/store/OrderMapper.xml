<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.mgv.store.mapper.OrderMapper">
    <insert id="insertOrder" parameterType="Order" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO MGV_ORDER
        (
         ORDER_ID,
         ORDER_TOTAL_PRICE,
         USER_ID
        )
        VALUES
            (#{id}, #{totalPrice}, #{user.id})
    </insert>
    <select id="getOrderList" resultType="Order">
    	SELECT
	    	ORDER_ID	AS orderId,	
			USER_ID		AS userId,
			USER_NAME	AS userName,
			ORDER_NAME	AS orderName,
			TOTAL_PRICE	AS totalPrice,
			CREATE_DATE	AS createDate,
			UPDATE_DATE	AS updateDate,
			ORDER_STATE	AS orderState
    	FROM
    		MGV_ORDER
    	WHERE
    	    ORDER_STATE LIKE '%완료'
		    OR
		    ORDER_STATE LIKE '%취소'
		ORDER BY
		    CREATE_DATE DESC 
		LIMIT
		    6;
    </select>

	<!-- pagnation -->
	<select id="getOrders" parameterType="map" resultType="Order">
		select *
			from (SELECT ROW_NUMBER() OVER (ORDER BY CREATE_DATE DESC) as ROW_NUM,
				ORDER_NAME        	AS orderName,
				USER_ID           	AS userId,
				TOTAL_PRICE       	AS totalPrice,
				PAY_METHOD			AS payMethod,
				CRETAE_DATE       	AS createDate,
				UPDATE_DATE       	AS updateDate,
				ORDER_STATE       	AS orderState
			FROM
				MGV_ORDER
			WHERE
				USER_ID = #{userId}
				<if test="status neq null and status != ''">
					AND ORDER_STATE = #{stat}
				</if>
			AND CREATE_DATE BETWEEN #{startDate} AND #{endDate}) as ORDER_ROW
		WHERE ROW_NUM BETWEEN #{begin} and #{end};
	</select>

	<!-- 건수 -->
	<select id="getTotalRowsByUserId" parameterType="string" resultType="int">
		SELECT COUNT(*)
		FROM
			MGV_ORDER
		WHERE
			USER_ID = #{userId}
			<if test="status neq null and status != ''">
				AND ORDER_STATE = #{status}
			</if>
		AND CREATE_DATE BETWEEN #{startDate} AND #{endDate}
	</select>

	<select id="getOrderById" parameterType="int" resultType="Order">
		select
			ORDER_NAME        AS orderName,
			USER_ID           AS userId,
			CRETAE_DATE       AS createDate,
			UPDATE_DATE       AS updateDate,
			TOTAL_PRICE       AS totalPrice,
			ORDER_STATE       AS orderState
		FROM
			MGV_ORDER
		WHERE
			ORDER_ID = #{orderId}
	</select>

	<update id="updateOrderById" parameterType="long">
		UPDATE MGV_ORDER
		SET PURCHASE_STATUS = '결제취소',
			PURCHASE_CANCELED_DATE = CURRENT_TIMESTAMP
		WHERE ORDER_ID = #{orderId}
	</update>
</mapper>